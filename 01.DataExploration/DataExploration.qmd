---
title: "Data Exploration"
format: html
editor: visual
---

#Longitudinal Data Analysis Pratical

Load the packages. If not installed please install first.

## Overview of data

```{r, include=FALSE}
library(foreign)
library(dplyr)


W01 <- read.spss("../00.Data/01. covid-19_wave1_survey_cls.sav", to.data.frame = TRUE)
summary(W01)
head(W01)

W02 <- read.spss("../00.Data/02. covid-19_wave2_survey_cls.sav", to.data.frame = TRUE)
summary(W02)
head(W02)

W03 <- read.spss("../00.Data/03. covid-19_wave3_survey_cls.sav", to.data.frame = TRUE)
summary(W03)
head(W03)

```

### Select Relevant Rows

The study looks into the participants with long-standing illness. Hence the following variable will be selected.

\*Demo = Demographic information Acronym

\*Mod\_ = Moderator

#### Wave 1

**Wave 1** Variable Table

| Type | Variable Acronym | Explanation |
|----|----|----|
| Demo | CW1_PSEX | Sex of Respondent |
| Mod_Cov | CW1_COVIDSYMPT_1 | Past 2 weeks COVID19 symptoms: Fever |
| Mod_Cov | CW1_COVIDSYMPT_2 | Past 2 weeks COVID19 symptoms: Cough - dry |
| Mod_Cov | CW1_COVIDSYMPT_3 | Past 2 weeks COVID19 symptoms: Cough - mucus or phlegm |
| Mod_Cov | CW1_COVIDSYMPT_4 | Past 2 weeks COVID19 symptoms: Sore throat |
| Mod_Cov | CW1_COVIDSYMPT_5 | Past 2 weeks COVID19 symptoms: Chest tightness |
| Mod_Cov | CW1_COVIDSYMPT_6 | Past 2 weeks COVID19 symptoms: Shortness of breath |
| Mod_Cov | CW1_COVIDSYMPT_7 | Past 2 weeks COVID19 symptoms: Runny nose |
| Mod_Cov | CW1_COVIDSYMPT_8 | Past 2 weeks COVID19 symptoms: Nasal congestion |
| Mod_Cov | CW1_COVIDSYMPT_18 | Past 2 weeks COVID19 symptoms: Sneezing |
| Mod_Cov | CW1_COVIDSYMPT_10 | Past 2 weeks COVID19 symptoms: Muscle or body aches |
| Mod_Cov | CW1_COVIDSYMPT_11 | Past 2 weeks COVID19 symptoms: Fatigue |
| Mod_Cov | CW1_COVIDSYMPT_12 | Past 2 weeks COVID19 symptoms: Unusual loose motions or diarrhoea |
| Mod_Cov | CW1_COVIDSYMPT_16 | Past 2 weeks COVID19 symptoms: Vomiting |
| Mod_Cov | CW1_COVIDSYMPT_13 | Past 2 weeks COVID19 symptoms: Loss of smell |
| Mod_Cov | CW1_COVIDSYMPT_14 | Past 2 weeks COVID19 symptoms: Loss of taste |
| Mod_Cov | CW1_COVIDSYMPT_17 | Past 2 weeks COVID19 symptoms: Skin rash |
| Mod_Cov | CW1_COVIDSYMPT_19 | Past 2 weeks COVID19 symptoms: Headaches |
| Mod_Cov | CW1_COVIDSYMPT_20 | Past 2 weeks COVID19 symptoms: Other |
| Mod_Cov | CW1_COVIDSYMPT_23 | Past 2 weeks no COVID19 symptoms experienced |
| Mod_Health | CW1_GHQ | Post-C19: Respondent self-assessment of general health |
| Mod_Health | CW1_GHQPRECOVID | Pre-C19: Respondent self-assessment of general health in 3 months preceding outbreak |
| IV | CW1_LLI_1 | long-standing illness 1: Cancer |
|  | CW1_LLI_2 | long-standing illness: Cystic fibrosis |
|  | CW1_LLI_3 | long-standing illness: Asthma |
|  | CW1_LLI_4 | long-standing illness: Chronic Obstructive Pulmonary Disease |
|  | CW1_LLI_5 | long-standing illness: Wheezy bronchitis |
|  | CW1_LLI_6 | long-standing illness: Diabetes |
|  | CW1_LLI_7 | long-standing illness: Recurrent backache/prolapsed disc/sciatica/other back probm |
|  | CW1_LLI_8 | long-standing illness: Problems with hearing |
|  | CW1_LLI_9 | long-standing illness: High blood pressure |
|  | CW1_LLI_10 | long-standing illness: Heart disease, congenital or acquired |
|  | CW1_LLI_11 | long-standing illness: Depression or other emotional/nervous/psychiatric probs |
|  | CW1_LLI_12 | long-standing illness: Obesity |
|  | CW1_LLI_13 | long-standing illness: Chronic Obstructive Airways Disease |
|  | CW1_LLI_14 | long-standing illness: Infection |
|  | CW1_LLI_15 | long-standing illness: HIV/Immunodeficiency |
|  | CW1_LLI_16 | long-standing illness: Conditions affecting the brain and nerves |
|  | CW1_LLI_17 | Respondent suffering from a long-standing illness: |
| Mod_Lonely | CW1_LONELY_1 | How often - lack companionship |
|  | CW1_LONELY_2 | How often - left out |
|  | CW1_LONELY_3 | How often - isolated from others |
|  | CW1_LONELY_4 | How often - lonely |
| DV_Kessler6 | CW1_PHDE | Felt depressed |
|  | CW1_PHHO | felt hopeless |
|  | CW1_PHRF | felt restless |
|  | CW1_PHEE | felt everything was an effort |
|  | CW1_PHWO | felt worthless |
|  | CW1_PHNE | felt nervous |
|  | CW1_HARM | has harmed self on purpose |
| DV_WEMWBS | CW1_WEMWBS_1 | feeling optimistic about the future |
|  | CW1_WEMWBS_2 | feeling useful |
|  | CW1_WEMWBS_3 | feeling relaxed |
|  | CW1_WEMWBS_4 | dealing with problems well |
|  | CW1_WEMWBS_5 | thinking clearly |
|  | CW1_WEMWBS_6 | thinking close to other people |
|  | CW1_WEMWBS_7 | able to make up my own mind about things |
| DV_MALAISE | CW1_MALAISE_1 | feel tired most of the time |
|  | CW1_MALAISE_2 | feel miserable or depressed |
|  | CW1_MALAISE_3 | get worried about things |
|  | CW1_MALAISE_4 | get in a violent rage |
|  | CW1_MALAISE_5 | suddenly become scared for no good reason |
|  | CW1_MALAISE_6 | easily upset or irritated |
|  | CW1_MALAISE_7 | constantly keyed up and jittery |
|  | CW1_MALAISE_8 | every little thing get on your nerves and wear you out |
|  | CW1_MALAISE_9 | heart often race like mad |
| DV_GHQ | CW1_GHQ121 | able to concentrate |
|  | CW1_GHQ122 | lost much sleep over worry |
|  | CW1_GHQ123 | felt that playing a useful part in things |
|  | CW1_GHQ124 | felt capable of making decisions about things |
|  | CW1_GHQ125 | felt constantly under strain |
|  | CW1_GHQ126 | couldn’t overcome difficulties |
|  | CW1_GHQ127 | able to enjoy normal day to day activities |
|  | CW1_GHQ128 | able to face up to problems |
|  | CW1_GHQ129 | feeling unhappy or depressed |
|  | CW1_GHQ1210 | losing confidence in self |
|  | CW1_GHQ1211 | thinking of self as a worthless person |
|  | CW1_GHQ1212 | feeling reasonably happy |
| DV_GAD | CW1_GAD2PHQ2_1 | Feeling Nervous, Anxious Or On Edge |
|  | CW1_GAD2PHQ2_2 | Not Being Able To Stop Or Control Worrying |
|  | CW1_GAD2PHQ2_3 | Little Interest Or Pleasure In Doing Things |
|  | CW1_GAD2PHQ2_4 | Feeling Down, Depressed Or Hopeless |
| DV_RPTT | CW1_RISK | willingness to take risks from 0 (Never) to 10 (Always) |
|  | CW1_PATIENT | how patient Respondent is from 0 (Never) to 10 (Always) |
|  | CW1_TRUST | how trusting of others from 0 (Not at all) to 10 (Extremely) |
|  | CW1_TRUSTPOLP | how trusting of Govmnt from 0 (Not at all) to 10 (Extremely) |

Select rows from the Wave 1 dataset

```{r, include=FALSE}

library(dplyr)

W01_A <- W01 %>%
  select(
    NCDSID, BCSID,NSID, MCSID, CW1_PSEX,
    CW1_COVIDSYMPT_1, CW1_COVIDSYMPT_2, CW1_COVIDSYMPT_3, CW1_COVIDSYMPT_4,
    CW1_COVIDSYMPT_5, CW1_COVIDSYMPT_6, CW1_COVIDSYMPT_7, CW1_COVIDSYMPT_8,
    CW1_COVIDSYMPT_18, CW1_COVIDSYMPT_10, CW1_COVIDSYMPT_11, CW1_COVIDSYMPT_12,
    CW1_COVIDSYMPT_16, CW1_COVIDSYMPT_13, CW1_COVIDSYMPT_14, CW1_COVIDSYMPT_17,
    CW1_COVIDSYMPT_19, CW1_COVIDSYMPT_20, CW1_COVIDSYMPT_23,
    CW1_GHQ, CW1_GHQPRECOVID,
    
    matches("^CW1_LLI_([1-9]|1[0-7])$"),
    matches("^CW1_LONELY_([1-4])$"),
    
    CW1_PHDE, CW1_PHHO, CW1_PHRF, CW1_PHEE, CW1_PHWO, CW1_PHNE,
    CW1_HARM,
    
    matches("^CW1_WEMWBS_([1-7])$"),
    matches("^CW1_MALAISE_([1-9]|1[0-9])$"),
    matches("^CW1_GHQ12([1-9]|1[0-2])$"),
    matches("^CW1_GAD2PHQ2_([1-4])$"),
    
    CW1_RISK, CW1_PATIENT, CW1_TRUST, CW1_TRUSTPOLP
  )
```

#### Wave 2

**Wave 2** Variable Table

| Type | Variable Acronym | Explanation |
|----|----|----|
| Demo | CW2_PSEX | Sex of Respondent |
| Mod_Cov | CW2_COVIDSYMPT_1 | Past 2 weeks COVID19 symptoms: Fever |
| Mod_Cov | CW2_COVIDSYMPT_2 | Past 2 weeks COVID19 symptoms: Cough - dry |
| DV_WEMWBS | CW2_WEMWBS_1 | feeling optimistic about the future |
|  | CW2_WEMWBS_2 | feeling useful |
|  | CW2_WEMWBS_3 | feeling relaxed |
|  | CW2_WEMWBS_4 | dealing with problems well |
|  | CW2_WEMWBS_5 | thinking clearly |
|  | CW2_WEMWBS_6 | feeling close to other people |
|  | CW2_WEMWBS_7 | able to make up my own mind about things |
| DV_GAD | CW2_GAD2PHQ2_1 | Feeling Nervous, Anxious Or On Edge |
|  | CW2_GAD2PHQ2_2 | Not Being Able To Stop Or Control Worrying |
|  | CW2_GAD2PHQ2_3 | Little Interest Or Pleasure In Doing Things |
|  | CW2_GAD2PHQ2_4 | Feeling Down, Depressed Or Hopeless |
| DV_RPTT | CW2_RISK | willingness to take risks from 0 (Never) to 10 (Always) |
|  | CW2_PATIENT | how patient respondent is from 0 (Never) to 10 (Always) |
|  | CW2_TRUST | how trusting of others from 0 (Not at all) to 10 (Extremely) |
|  | CW2_TRUSTPOLP | how trusting of Government from 0 (Not at all) to 10 (Extremely) |

```{r, include=FALSE}

# select rows from Wave2
W02_A <- W02 %>%
  select(NCDSID, BCSID,NSID, MCSID, any_of(c(
    "CW2_PSEX",
    "CW2_COVIDSYMPT_1", "CW2_COVIDSYMPT_2", "CW2_COVIDSYMPT_3", "CW2_COVIDSYMPT_4",
    "CW2_COVIDSYMPT_5", "CW2_COVIDSYMPT_6", "CW2_COVIDSYMPT_7", "CW2_COVIDSYMPT_8",
    "CW2_COVIDSYMPT_10", "CW2_COVIDSYMPT_11", "CW2_COVIDSYMPT_12",
    "CW2_COVIDSYMPT_13", "CW2_COVIDSYMPT_14", "CW2_COVIDSYMPT_16", 
    "CW2_COVIDSYMPT_17", "CW2_COVIDSYMPT_18", "CW2_COVIDSYMPT_19", 
    "CW2_COVIDSYMPT_20", "CW2_COVIDSYMPT_23",

    "CW2_PHDE", "CW2_PHHO", "CW2_PHRF", "CW2_PHEE", "CW2_PHWO", "CW2_PHNE",
    
    paste0("CW2_LLI_", 1:17),
    paste0("CW2_LONELY_", 1:4),
    paste0("CW2_WEMWBS_", 1:7),
    paste0("CW2_MALAISE_", 1:9),
    paste0("CW2_GAD2PHQ2_", 1:4),
    paste0("CW2_GHQ12", 1:12),

    "CW2_RISK", "CW2_PATIENT", "CW2_TRUST", "CW2_TRUSTPOLP"
  )))
```

#### Wave 3

**Wave 3** Variable Table

| Type | Variable Acronym | Explanation |
|----|----|----|
| Demo | CW3_PSEX | Sex of Respondent |
| Mod_Cov | CW3_COVIDSYMPT_1 | Past 2 weeks COVID19 symptoms: Fever |
| Mod_Cov | CW3_COVIDSYMPT_2 | Past 2 weeks COVID19 symptoms: Cough - dry |
| DV_WEMWBS | CW3_WEMWBS_1 | feeling optimistic about the future |
|  | CW3_WEMWBS_2 | feeling useful |
|  | CW3_WEMWBS_3 | feeling relaxed |
|  | CW3_WEMWBS_4 | dealing with problems well |
|  | CW3_WEMWBS_5 | thinking clearly |
|  | CW3_WEMWBS_6 | feeling close to other people |
|  | CW3_WEMWBS_7 | able to make up my own mind about things |
| DV_MALAISE | CW3_MALAISE_1 | feel tired most of the time |
|  | CW3_MALAISE_2 | feel miserable or depressed |
|  | CW3_MALAISE_3 | get worried about things |
|  | CW3_MALAISE_4 | get in a violent rage |
|  | CW3_MALAISE_5 | suddenly become scared for no good reason |
|  | CW3_MALAISE_6 | easily upset or irritated |
|  | CW3_MALAISE_7 | constantly keyed up and jittery |
|  | CW3_MALAISE_8 | every little thing gets on your nerves and wears you out |
|  | CW3_MALAISE_9 | heart often races like mad |
| DV_GAD | CW3_GAD2PHQ2_1 | Feeling Nervous, Anxious Or On Edge |
|  | CW3_GAD2PHQ2_2 | Not Being Able To Stop Or Control Worrying |
|  | CW3_GAD2PHQ2_3 | Little Interest Or Pleasure In Doing Things |
|  | CW3_GAD2PHQ2_4 | Feeling Down, Depressed Or Hopeless |
| DV_RPTT | CW3_RISK | willingness to take risks from 0 (Never) to 10 (Always) |
|  | CW3_PATIENT | how patient respondent is from 0 (Never) to 10 (Always) |
|  | CW3_TRUST | how trusting of others from 0 (Not at all) to 10 (Extremely) |
|  | CW3_TRUSTPOLP | how trusting of Government from 0 (Not at all) to 10 (Extremely) |

```{r, include=FALSE}

W03_A <- W03 %>%
  select(NCDSID, BCSID,NSID, MCSID, any_of(c(
    "CW3_PSEX",
    "CW3_COVIDSYMPT_1", "CW3_COVIDSYMPT_2", "CW3_COVIDSYMPT_3", "CW3_COVIDSYMPT_4",
    "CW3_COVIDSYMPT_5", "CW3_COVIDSYMPT_6", "CW3_COVIDSYMPT_7", "CW3_COVIDSYMPT_8",
    "CW3_COVIDSYMPT_10", "CW3_COVIDSYMPT_11", "CW3_COVIDSYMPT_12",
    "CW3_COVIDSYMPT_13", "CW3_COVIDSYMPT_14", "CW3_COVIDSYMPT_16", 
    "CW3_COVIDSYMPT_17", "CW3_COVIDSYMPT_18", "CW3_COVIDSYMPT_19", 
    "CW3_COVIDSYMPT_20", "CW3_COVIDSYMPT_23",

    "CW3_PHDE", "CW3_PHHO", "CW3_PHRF", "CW3_PHEE", "CW3_PHWO", "CW3_PHNE",
    
    paste0("CW3_LLI_", 1:17),
    paste0("CW3_LONELY_", 1:4),
    paste0("CW3_WEMWBS_", 1:7),
    paste0("CW3_MALAISE_", 1:9),
    paste0("CW3_GAD2PHQ2_", 1:4),
    paste0("CW3_GHQ12", 1:12),

    "CW3_RISK", "CW3_PATIENT", "CW3_TRUST", "CW3_TRUSTPOLP"
  )))

```

### Combine IDs: NCDSID, BCSID,NSID, MCSID

```{r}
W01_A <- W01_A %>%
  mutate(across(c(NCDSID, BCSID, NSID, MCSID), ~ trimws(.)))

# Step 2: Create a new ID column from the first non-missing, non-blank ID
W01_A <- W01_A %>%
  mutate(ID = coalesce(
    na_if(NCDSID, ""), 
    na_if(BCSID, ""), 
    na_if(NSID, ""), 
    na_if(MCSID, "")
  ))

# Step 3: Filter out rows with no ID at all
W01_A <- W01_A %>%
  filter(!is.na(ID))

W02_A <- W02_A %>%
  mutate(across(c(NCDSID, BCSID, NSID, MCSID), ~ trimws(.)))

W02_A <- W02_A %>%
  mutate(ID = coalesce(
    na_if(NCDSID, ""), 
    na_if(BCSID, ""), 
    na_if(NSID, ""), 
    na_if(MCSID, "")
  ))

W02_A <- W02_A %>%
  filter(!is.na(ID))

W03_A <- W03_A %>%
  mutate(across(c(NCDSID, BCSID, NSID, MCSID), ~ trimws(.)))

W03_A <- W03_A %>%
  mutate(ID = coalesce(
    na_if(NCDSID, ""), 
    na_if(BCSID, ""), 
    na_if(NSID, ""), 
    na_if(MCSID, "")
  ))

W03_A <- W03_A %>%
  filter(!is.na(ID))
```

## Demographic Exploration

Number of participant how completed from Wave 1 to 3 are 11740

```{r}
# Step 1: Extract IDs from each wave
ids_w1 <- W01_A$ID
ids_w2 <- W02_A$ID
ids_w3 <- W03_A$ID

# Step 2: Find common IDs across all three waves
common_ids <- Reduce(intersect, list(ids_w1, ids_w2, ids_w3))

# Step 3: Count the number of participants
length(common_ids)
```

Subset datasets to only those participants

```{r}


W01_complete <- W01_A %>%
  filter(ID %in% common_ids) 

W02_complete <- W02_A %>%
  filter(ID %in% common_ids) 

W03_complete <- W03_A %>%
  filter(ID %in% common_ids) 


#Ensure uniqueness before merging
W01_clean <- W01_complete %>%
  group_by(ID) %>%
  summarise(across(everything(), ~ first(na.omit(.))), .groups = "drop")

W02_clean <- W02_complete %>%
  group_by(ID) %>%
  summarise(across(everything(), ~ first(na.omit(.))), .groups = "drop")

W03_clean <- W03_complete %>%
  group_by(ID) %>%
  summarise(across(everything(), ~ first(na.omit(.))), .groups = "drop")

merged_all <- W01_clean %>%
  inner_join(W02_clean, by = "ID") %>%
  inner_join(W03_clean, by = "ID")


n_distinct(merged_all$ID)
nrow(merged_all) 


```

Summary of participants with longterm illness in Wave 1

```{r}

#List the relevant long-term illness variables in Wave 1
lli_vars <- paste0("CW1_LLI_", 1:17)

#Create a summary table
lli_summary <- merged_all %>%
  summarise(
    Total_Participants = n(),
    across(all_of(lli_vars), ~ sum(. == "Yes", na.rm = TRUE), .names = "n_{.col}")
  )

#Rename 
summary_out <- t(lli_summary)

rownames(summary_out) <- recode(
  rownames(summary_out),
  "n_CW1_LLI_1" = "Cancer",
  "n_CW1_LLI_2" = "Cystic fibrosis",
  "n_CW1_LLI_3" = "Asthma",
  "n_CW1_LLI_4" = "Chronic Obstructive Pulmonary Disease",
  "n_CW1_LLI_5" = "Wheezy bronchitis",
  "n_CW1_LLI_6" = "Diabetes",
  "n_CW1_LLI_7" = "Recurrent backache/prolapsed disc/sciatica/other back problem",
  "n_CW1_LLI_8" = "Problems with hearing",
  "n_CW1_LLI_9" = "High blood pressure",
  "n_CW1_LLI_10" = "Heart disease, congenital or acquired",
  "n_CW1_LLI_11" = "Depression/emotional/nervous/psychiatric probs ",
  "n_CW1_LLI_12" = "Obesity",
  "n_CW1_LLI_13" = "Chronic Obstructive Airways Disease",
  "n_CW1_LLI_14" = "Infection", 
  "n_CW1_LLI_15" = "HIV/Immunodeficiency ",
  "n_CW1_LLI_16" = "Conditions affecting the brain and nerves",
  "n_CW1_LLI_17" = "Any Long Term Illness"
)

print(summary_out)

```

Summarise Sex within 2 IV groups

```{r}
summary_gender <- merged_all %>%
  filter(CW1_LLI_17 %in% c("Yes", "No")) %>%
  count(CW1_LLI_17, CW1_PSEX, name = "Count") %>%
  group_by(CW1_LLI_17) %>%
  mutate(Percent = round(Count / sum(Count) * 100, 1)) %>%
  ungroup() %>%
  mutate(
    CW1_LLI_17 = recode(CW1_LLI_17, "Yes" = "Any Long Term Illness", "No" = "No Long Term Illness"),
    CW1_PSEX = recode(CW1_PSEX, "Male" = "M", "Female" = "F")
  )


print(summary_gender)
```

## Primary research question:

How does having a long-term illness affect self-reported mental health outcomes during the COVID-19 pandemic, compared to individuals without such conditions?

### Recode the questionnaire:

to get total scores of mental health outcomes. If all items of the questionnaire were NA, than the total score is NA.

```{r,  include=FALSE}


# 1. MALAISE
# Recode Yes/No to 1/0, then sum
merged_all <- merged_all %>%
  mutate(
    MALAISE_W1 = case_when(
      if_all(all_of(paste0("CW1_MALAISE_", 1:9)), ~ is.na(.x)) ~ NA_real_,
      TRUE ~ rowSums(across(
        all_of(paste0("CW1_MALAISE_", 1:9)),
        ~ case_when(
          . == "Yes" ~ 1,
          . == "No" ~ 0,
          TRUE ~ NA_real_
        )
      ), na.rm = TRUE)
    ),
    
    MALAISE_W2 = case_when(
      if_all(all_of(paste0("CW2_MALAISE_", 1:9)), ~ is.na(.x)) ~ NA_real_,
      TRUE ~ rowSums(across(
        all_of(paste0("CW2_MALAISE_", 1:9)),
        ~ case_when(
          . == "Yes" ~ 1,
          . == "No" ~ 0,
          TRUE ~ NA_real_
        )
      ), na.rm = TRUE)
    ),
    
    MALAISE_W3 = case_when(
      if_all(all_of(paste0("CW3_MALAISE_", 1:9)), ~ is.na(.x)) ~ NA_real_,
      TRUE ~ rowSums(across(
        all_of(paste0("CW3_MALAISE_", 1:9)),
        ~ case_when(
          . == "Yes" ~ 1,
          . == "No" ~ 0,
          TRUE ~ NA_real_
        )
      ), na.rm = TRUE)
    )
  )

#2. GAD
#Recode  Not at all/ Several days/More than half the days/ Nearly every day to 0/1/2/3, then sum
merged_all <- merged_all %>%
  mutate(
    GAD_W1 = case_when(
      if_all(all_of(paste0("CW1_GAD2PHQ2_", 1:4)), ~ is.na(.x)) ~ NA_real_,
      TRUE ~ rowSums(across(
        all_of(paste0("CW1_GAD2PHQ2_", 1:4)),
        ~ case_when(
          . == "Not at all" ~ 0,
          . == "Several days" ~ 1,
          . == "More than half the days" ~ 2,
          . == "Nearly every day" ~ 3,
          TRUE ~ NA_real_
        )
      ), na.rm = TRUE)
    ),
    
    GAD_W2 = case_when(
      if_all(all_of(paste0("CW2_GAD2PHQ2_", 1:4)), ~ is.na(.x)) ~ NA_real_,
      TRUE ~ rowSums(across(
        all_of(paste0("CW2_GAD2PHQ2_", 1:4)),
        ~ case_when(
          . == "Not at all" ~ 0,
          . == "Several days" ~ 1,
          . == "More than half the days" ~ 2,
          . == "Nearly every day" ~ 3,
          TRUE ~ NA_real_
        )
      ), na.rm = TRUE)
    ),
    
    GAD_W3 = case_when(
      if_all(all_of(paste0("CW3_GAD2PHQ2_", 1:4)), ~ is.na(.x)) ~ NA_real_,
      TRUE ~ rowSums(across(
        all_of(paste0("CW3_GAD2PHQ2_", 1:4)),
        ~ case_when(
          . == "Not at all" ~ 0,
          . == "Several days" ~ 1,
          . == "More than half the days" ~ 2,
          . == "Nearly every day" ~ 3,
          TRUE ~ NA_real_
        )
      ), na.rm = TRUE)
    )
  )


#3 RPTT
# CW1_RISK: Never\n0, 1, 2, 3,4,5,6,7,8,9,Always\n10 
# CW1_PATIENT: Never\n0, 1, 2, 3,4,5,6,7,8,9,Always\n10 
# CW1_TRUST: Not at all trusting\n0, 1, 2, 3,4,5,6,7,8,9,Extremely trusting\n10
# CW1_TRUSTPOLP: Not at all trusting\n0, 1, 2, 3,4,5,6,7,8,9,Extremely trusting\n10

merged_all <- merged_all %>%
  mutate(
    CW1_RISK = case_when(
      CW1_RISK == "Never\n0" ~ 0,
      CW1_RISK == "Always\n10" ~ 10,
      TRUE ~ as.numeric(as.character(CW1_RISK))
    ),
    CW1_PATIENT = case_when(
      CW1_PATIENT == "Never\n0" ~ 0,
      CW1_PATIENT == "Always\n10" ~ 10,
      TRUE ~ as.numeric(as.character(CW1_PATIENT))
    ),
    CW2_RISK = case_when(
      CW2_RISK == "Never\n0" ~ 0,
      CW2_RISK == "Always\n10" ~ 10,
      TRUE ~ as.numeric(as.character(CW2_RISK))
    ),
    CW3_RISK = case_when(
      CW3_RISK == "Never\n0" ~ 0,
      CW3_RISK == "Always\n10" ~ 10,
      TRUE ~ as.numeric(as.character(CW3_RISK))
    ),
    CW2_PATIENT = case_when(
      CW2_PATIENT == "Never\n0" ~ 0,
      CW2_PATIENT == "Always\n10" ~ 10,
      TRUE ~ as.numeric(as.character(CW2_PATIENT))
    ),
    CW3_PATIENT = case_when(
      CW3_PATIENT == "Never\n0" ~ 0,
      CW3_PATIENT == "Always\n10" ~ 10,
      TRUE ~ as.numeric(as.character(CW3_PATIENT))
    ),
    
  )

merged_all <- merged_all %>%
  mutate(
    CW1_TRUST = case_when(
      CW1_TRUST == "Not at all trusting\n0" ~ 0,
      CW1_TRUST == "Extremely trusting\n10" ~ 10,
      TRUE ~ as.numeric(as.character(CW1_TRUST))
    ),
    CW1_TRUSTPOLP = case_when(
      CW1_TRUSTPOLP == "Not at all trusting\n0" ~ 0,
     CW1_TRUSTPOLP== "Extremely trusting\n10" ~ 10,
      TRUE ~ as.numeric(as.character(CW1_TRUSTPOLP))
    ),
    CW2_TRUST = case_when(
      CW2_TRUST == "Not at all trusting\n0" ~ 0,
      CW2_TRUST == "Extremely trusting\n10" ~ 10,
      TRUE ~ as.numeric(as.character(CW2_TRUST))
    ),
    CW3_TRUST = case_when(
      CW3_TRUST == "Not at all trusting\n0" ~ 0,
      CW3_TRUST == "Extremely trusting\n10" ~ 10,
      TRUE ~ as.numeric(as.character(CW3_TRUST))
    ),
    CW2_TRUSTPOLP = case_when(
      CW2_TRUSTPOLP == "Not at all trusting\n0" ~ 0,
     CW2_TRUSTPOLP== "Extremely trusting\n10" ~ 10,
      TRUE ~ as.numeric(as.character(CW2_TRUSTPOLP))
    ),
    CW3_TRUSTPOLP = case_when(
      CW3_TRUSTPOLP == "Not at all trusting\n0" ~ 0,
     CW3_TRUSTPOLP== "Extremely trusting\n10" ~ 10,
      TRUE ~ as.numeric(as.character(CW3_TRUSTPOLP))
    ),
  )

merged_all <- merged_all %>%
  mutate(
    RPTT_W1 = case_when(
      if_all(c(CW1_RISK, CW1_PATIENT, CW1_TRUST, CW1_TRUSTPOLP), ~ is.na(.x)) ~ NA_real_,
      TRUE ~ rowSums(across(c(CW1_RISK, CW1_PATIENT, CW1_TRUST, CW1_TRUSTPOLP)), na.rm = TRUE)
    ),
    
    RPTT_W2 = case_when(
      if_all(c(CW2_RISK, CW2_PATIENT, CW2_TRUST, CW2_TRUSTPOLP), ~ is.na(.x)) ~ NA_real_,
      TRUE ~ rowSums(across(c(CW2_RISK, CW2_PATIENT, CW2_TRUST, CW2_TRUSTPOLP)), na.rm = TRUE)
    ),
    
    RPTT_W3 = case_when(
      if_all(c(CW3_RISK, CW3_PATIENT, CW3_TRUST, CW3_TRUSTPOLP), ~ is.na(.x)) ~ NA_real_,
      TRUE ~ rowSums(across(c(CW3_RISK, CW3_PATIENT, CW3_TRUST, CW3_TRUSTPOLP)), na.rm = TRUE)
    )
  )

#4. Lonely

merged_all <- merged_all %>%
  mutate(
    Lonely_W1 = case_when(
      if_all(all_of(paste0("CW1_LONELY_", 1:4)), ~ is.na(.x)) ~ NA_real_,
      TRUE ~ rowSums(across(
        all_of(paste0("CW1_LONELY_", 1:4)),
        ~ case_when(
          . == "Hardly ever" ~ 0,
          . == "Some of the time" ~ 1,
          . == "Often" ~ 2,
          TRUE ~ NA_real_
        )
      ), na.rm = TRUE)
    ),
    
    Lonely_W2 = case_when(
      if_all(all_of(paste0("CW2_LONELY_", 1:4)), ~ is.na(.x)) ~ NA_real_,
      TRUE ~ rowSums(across(
        all_of(paste0("CW2_LONELY_", 1:4)),
        ~ case_when(
          . == "Hardly ever" ~ 0,
          . == "Some of the time" ~ 1,
          . == "Often" ~ 2,
          TRUE ~ NA_real_
        )
      ), na.rm = TRUE)
    ),
    
    Lonely_W3 = case_when(
      if_all(all_of(paste0("CW3_LONELY_", 1:4)), ~ is.na(.x)) ~ NA_real_,
      TRUE ~ rowSums(across(
        all_of(paste0("CW3_LONELY_", 1:4)),
        ~ case_when(
          . == "Hardly ever" ~ 0,
          . == "Some of the time" ~ 1,
          . == "Often" ~ 2,
          TRUE ~ NA_real_
        )
      ), na.rm = TRUE)
    )
  )


#5. Kessler 

#CW1_PHDE，CW1_PHHO，CW1_PHRF，CW1_PHEE，CW1_PHWO，CW1_PHNE
merged_all <- merged_all %>%
  mutate(
    Kessler_W1 = case_when(
      if_all(all_of(c("CW1_PHDE", "CW1_PHHO", "CW1_PHRF", "CW1_PHEE", "CW1_PHWO", "CW1_PHNE")), ~ is.na(.x)) ~ NA_real_,
      TRUE ~ rowSums(across(
        all_of(c("CW1_PHDE", "CW1_PHHO", "CW1_PHRF", "CW1_PHEE", "CW1_PHWO", "CW1_PHNE")),
        ~ case_when(
          . == "All of the time" ~ 4,
          . == "Most of the time" ~ 3,
          . == "Some of the time" ~ 2,
          . == "A little of the time" ~ 1,
          . == "None of the time" ~ 0,
          TRUE ~ NA_real_
        )
      ), na.rm = TRUE)
    ),

    Kessler_W2 = case_when(
      if_all(all_of(c("CW2_PHDE", "CW2_PHHO", "CW2_PHRF", "CW2_PHEE", "CW2_PHWO", "CW2_PHNE")), ~ is.na(.x)) ~ NA_real_,
      TRUE ~ rowSums(across(
        all_of(c("CW2_PHDE", "CW2_PHHO", "CW2_PHRF", "CW2_PHEE", "CW2_PHWO", "CW2_PHNE")),
        ~ case_when(
          . == "All of the time" ~ 4,
          . == "Most of the time" ~ 3,
          . == "Some of the time" ~ 2,
          . == "A little of the time" ~ 1,
          . == "None of the time" ~ 0,
          TRUE ~ NA_real_
        )
      ), na.rm = TRUE)
    ),

    Kessler_W3 = case_when(
      if_all(all_of(c("CW3_PHDE", "CW3_PHHO", "CW3_PHRF", "CW3_PHEE", "CW3_PHWO", "CW3_PHNE")), ~ is.na(.x)) ~ NA_real_,
      TRUE ~ rowSums(across(
        all_of(c("CW3_PHDE", "CW3_PHHO", "CW3_PHRF", "CW3_PHEE", "CW3_PHWO", "CW3_PHNE")),
        ~ case_when(
          . == "All of the time" ~ 4,
          . == "Most of the time" ~ 3,
          . == "Some of the time" ~ 2,
          . == "A little of the time" ~ 1,
          . == "None of the time" ~ 0,
          TRUE ~ NA_real_
        )
      ), na.rm = TRUE)
    )
  )


#6 WEMWBS

recode_wemwbs <- function(x) {
  case_when(
    x == "All of the time" ~ 4,
    x == "Often" ~ 3,
    x == "Some of the time" ~ 2,
    x == "Rarely" ~ 1,
    x == "None of the time" ~ 0,
    TRUE ~ NA_real_
  )
}
merged_all <- merged_all %>%
  mutate(
    WEMWBS_W1 = if_else(
      if_all(all_of(paste0("CW1_WEMWBS_", 1:7)), is.na),
      NA_real_,
      rowSums(across(all_of(paste0("CW1_WEMWBS_", 1:7)), recode_wemwbs), na.rm = TRUE)
    ),
    WEMWBS_W2 = if_else(
      if_all(all_of(paste0("CW2_WEMWBS_", 1:7)), is.na),
      NA_real_,
      rowSums(across(all_of(paste0("CW2_WEMWBS_", 1:7)), recode_wemwbs), na.rm = TRUE)
    ),
    WEMWBS_W3 = if_else(
      if_all(all_of(paste0("CW3_WEMWBS_", 1:7)), is.na),
      NA_real_,
      rowSums(across(all_of(paste0("CW3_WEMWBS_", 1:7)), recode_wemwbs), na.rm = TRUE)
    )
  )

#7 GHQ12  

recode_GHQ <- function(x) {
  case_when(
    x == " Much more than usual" ~ 3,
    x == "Rather more than usual" ~ 2,
    x == "No more than usual" ~ 1,
    x == "Not at all" ~ 0,
    TRUE ~ NA_real_
  )
}
merged_all <- merged_all %>%
  mutate(
    GHQ_W1 = case_when(
      if_all(all_of(paste0("CW1_GHQ12", 1:12)), ~ is.na(.x)) ~ NA_real_,
      TRUE ~ rowSums(across(all_of(paste0("CW1_GHQ12", 1:12)), recode_GHQ), na.rm = TRUE)
    ),
    
    GHQ_W2 = case_when(
      if_all(all_of(paste0("CW2_GHQ12", 1:12)), ~ is.na(.x)) ~ NA_real_,
      TRUE ~ rowSums(across(all_of(paste0("CW2_GHQ12", 1:12)), recode_GHQ), na.rm = TRUE)
    ),
    
    GHQ_W3 = case_when(
      if_all(all_of(paste0("CW3_GHQ12", 1:12)), ~ is.na(.x)) ~ NA_real_,
      TRUE ~ rowSums(across(all_of(paste0("CW3_GHQ12", 1:12)), recode_GHQ), na.rm = TRUE)
    )
  )

```

### Final check

before running Structural Equation Modeling (SEM)

#### Missing data

```{r}
sem_vars_W1 <- c("MALAISE_W1", "GAD_W1", "RPTT_W1", "Lonely_W1", "Kessler_W1", "WEMWBS_W1", "GHQ_W1")
sapply(merged_all[sem_vars_W1], function(x) mean(is.na(x)))

sem_vars_W2 <- c("MALAISE_W2", "GAD_W2", "RPTT_W2", "Lonely_W2", "Kessler_W2", "WEMWBS_W2", "GHQ_W2")
sapply(merged_all[sem_vars_W2], function(x) mean(is.na(x)))

sem_vars_W3 <- c("MALAISE_W3", "GAD_W3", "RPTT_W3", "Lonely_W3", "Kessler_W3", "WEMWBS_W3", "GHQ_W3")
sapply(merged_all[sem_vars_W3], function(x) mean(is.na(x)))
```

GHQ_W1–3(88%), Kessler_W1–3(75%), WEMWBS_W1–3(75%) high missing due to only one cohort out of four included these measures. May consider dropping these from the model.

Exclude who did not report CW1_LLI_17 (any longitudinal disease)

```{r}
merged_all<- merged_all %>%
  filter(!is.na(CW1_LLI_17))
```

### SEM for all participant

1.  Model fit is poor. -\> Dropped RPTT because it is negative and weak (–0.35) → problematic.

2.  Model fit is still poor (RMSEA \> 0.2 is very high).Latent factors are stable. -\> add residual covariances (GAD and LONELY correlated)

3.  Model fit is still poor (RMSEA \> 0.2). CFI increased. Variables unstable -\> dropped residual covariances. Added Time-invariant

```{r}

library(lavaan)

merged_all$CW1_PSEX <- as.numeric(merged_all$CW1_PSEX == "Female")  # 1 = Female, 0 = Male

long_model_cov <- '
  # Measurement model
    MH_W1 =~ GAD_W1 + Lonely_W1 + Kessler_W1 + WEMWBS_W1
MH_W2 =~ GAD_W2 + Lonely_W2 + Kessler_W2 + WEMWBS_W2
MH_W3 =~ GAD_W3 + Lonely_W3 + Kessler_W3 + WEMWBS_W3

 # Time-invariant residual covariances (correlated uniquenesses)
  
  GAD_W1 ~~ GAD_W2 + GAD_W3
  GAD_W2 ~~ GAD_W3

  Lonely_W1 ~~ Lonely_W2 + Lonely_W3
  Lonely_W2 ~~ Lonely_W3

  Kessler_W1 ~~ Kessler_W2 + Kessler_W3
  Kessler_W2 ~~ Kessler_W3

  WEMWBS_W1 ~~ WEMWBS_W2 + WEMWBS_W3
  WEMWBS_W2 ~~ WEMWBS_W3

  # Latent growth model
  i =~ 1*MH_W1 + 1*MH_W2 + 1*MH_W3
  s =~ 0*MH_W1 + 1*MH_W2 + 2*MH_W3

  # Regress intercept and slope on LLI group
  i ~ CW1_LLI_17 + CW1_PSEX
  s ~ CW1_LLI_17 + CW1_PSEX
'

fit_long_cov <- sem(long_model_cov, 
                    data = merged_all, 
                    estimator = "MLR", 
                    missing = "fiml")
summary(fit_long_cov, fit.measures = TRUE, standardized = TRUE)


```

Interpretation:

The SEM model demonstrated excellent fit (CFI = 0.989, TLI = 0.984, RMSEA = 0.027, SRMR = 0.041), indicating that the latent structure of mental health across three waves was well captured by the model.

The intercept of the latent mental health trajectory (`i`) was significantly predicted by both **long-term illness** (`CW1_LLI_17`, β = 0.165, *p* \< .001) and **sex** (`CW1_PSEX`, β = 0.208, *p* \< .001), suggesting that individuals with long-term illnesses and females reported poorer mental health at baseline (higher scores indicate worse mental health).

For the slope (`s`), **sex** was a significant predictor (β = 0.043, *p* = .039), indicating a slightly steeper increase in mental health problems over time among females. However, **long-term illness** was **not** a significant predictor of slope (β = 0.004, *p* = .862), suggesting that although people with long-term illnesses started worse off, their rate of change over time was similar to others.

The latent mental health construct was robustly defined by GAD, Kessler, Loneliness (positive loadings), and WEMWBS (negative loadings), across all waves. Stability across timepoints was confirmed by moderate factor loadings and high residual correlations between indicator variables.

:::

```{r}
#install package if you havent 

library(lavaanPlot)

# Create SEM diagram with visual emphasis
lavaanPlot(
  model = fit_long_cov,
  coefs = TRUE,         # Display regression coefficients on the arrows
  stand = TRUE,         # Use standardized estimates (so coefficients are on the same scale)
  covs = TRUE,          # Show covariances between residuals
  stars = "regress",    # Add significance stars to regression paths
  node_options = list(
    shape = "box",            # Variable nodes shown as rectangles
    fontname = "Helvetica",   # Use Helvetica font
    fontsize = 13,            # Font size for variable labels
    color = "blue"            # Blue font color for variable labels
  ),
  edge_options = list(
    fontsize = 11,            # Font size for coefficients
    color = "black"           # Base color for paths (manual edit needed for highlights)
  ),
  graph_options = list(
    rankdir = "LR"            # Layout left-to-right for better readability
  )
)

```

### Explorational SEM

1.  Exclude participants who have depression or other emotional/nervous/psychiatric probs. Test SEM again. -\> dropped GHQ due to low loadings and high residuals

```{r}


merged_all_dep <- merged_all %>%
  filter(CW1_LLI_11 != "Yes" & !is.na(CW1_LLI_11))

long_model_dep <- '
  # Measurement model
  MH_W1 =~ GAD_W1 + Lonely_W1 + Kessler_W1 + WEMWBS_W1
MH_W2 =~ GAD_W2 + Lonely_W2 + Kessler_W2 + WEMWBS_W2
MH_W3 =~ GAD_W3 + Lonely_W3 + Kessler_W3 + WEMWBS_W3

#time invariance 

  GAD_W1 ~~ GAD_W2 + GAD_W3
  GAD_W2 ~~ GAD_W3

  Lonely_W1 ~~ Lonely_W2 + Lonely_W3
  Lonely_W2 ~~ Lonely_W3

  Kessler_W1 ~~ Kessler_W2 + Kessler_W3
  Kessler_W2 ~~ Kessler_W3

  WEMWBS_W1 ~~ WEMWBS_W2 + WEMWBS_W3
  WEMWBS_W2 ~~ WEMWBS_W3
  
  # Latent growth model
  i =~ 1*MH_W1 + 1*MH_W2 + 1*MH_W3
  s =~ 0*MH_W1 + 1*MH_W2 + 2*MH_W3

  # Regress intercept and slope on LLI group
  i ~ CW1_LLI_17 + CW1_PSEX
  s ~ CW1_LLI_17 + CW1_PSEX
'

fit_long_dep <- sem(long_model_dep, 
                    data = merged_all_dep, 
                    estimator = "MLR", 
                    missing = "fiml")
summary(fit_long_dep, fit.measures = TRUE, standardized = TRUE)

```

After excluding participants with a history of depression, the model still showed excellent fit (CFI = 0.989, TLI = 0.984, RMSEA = 0.025, SRMR = 0.040).

The pattern of results shifted slightly: **long-term illness** was now **negatively associated** with baseline mental health (β = -0.034, *p* = .007), meaning that even among those without reported depression, having a long-term illness predicted worse baseline mental health.

Sex remained a significant predictor of intercept (β = 0.195, *p* \< .001), again suggesting females started with worse mental health. Interestingly, **both long-term illness** (β = 0.045, *p* = .031) and **sex** (β = 0.052, *p* = .011) significantly predicted the **slope**, suggesting more pronounced worsening over time in those with long-term illness and in females.

This indicates that among non-depressed individuals, long-term illness not only affected baseline levels but also predicted a steeper decline in mental health across waves.

```{r}
lavaanPlot(
  model = fit_long_dep,
  coefs = TRUE,         
  stand = TRUE,         
  covs = TRUE,          
  stars = "regress",    
  node_options = list(
    shape = "box",
    fontname = "Helvetica",
    fontsize = 13,
    color = "blue"
  ),
  edge_options = list(
    fontsize = 11,
    color = "black"
  ),
  graph_options = list(
    rankdir = "LR"
  )
)
```

```{r}
summary(fit_long_cov, fit.measures = TRUE, standardized = TRUE)
summary(fit_long_dep, fit.measures = TRUE, standardized = TRUE)

```
